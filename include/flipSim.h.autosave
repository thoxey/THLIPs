#ifndef __FLIPSIM__
#define __FLIPSIM__

#include "MACGrid.h"

//----------------------------------------------------------------------------------------------------------------------
/// @file flipSim.h
/// @brief The simulation header, contains the main simulation code
/// @author Tom Hoxey
/// @version 1.0
/// @date 19/01/17 Initial version
//----------------------------------------------------------------------------------------------------------------------

class FlipSim
{
public:
    //Constructors
    //----------------------------------------------------------------------------------------------------------------------
    /// @brief ctor
    //----------------------------------------------------------------------------------------------------------------------
    FlipSim(uvec3 _size);
    //----------------------------------------------------------------------------------------------------------------------
    /// @brief ctor
    //----------------------------------------------------------------------------------------------------------------------
    FlipSim(uint _i, uint _j, uint _k);

    //----------------------------------------------------------------------------------------------------------------------
    /// @brief Steps the simulation forward once
    //----------------------------------------------------------------------------------------------------------------------
    void step(real dt);
private:
    //The steps of the fluid simulation
    //----------------------------------------------------------------------------------------------------------------------
    /// @brief Updates the grid cells depending on the particles
    //----------------------------------------------------------------------------------------------------------------------
    void updateGrid();
    //----------------------------------------------------------------------------------------------------------------------
    /// @brief Calculate the pressure in the cells
    //----------------------------------------------------------------------------------------------------------------------
    void calculatePressure();
    //----------------------------------------------------------------------------------------------------------------------
    /// @brief Applies the pressure calculations to each of the cells depending on thier contents
    //----------------------------------------------------------------------------------------------------------------------
    void applyPressure(real dt, real density, real dx);
    //----------------------------------------------------------------------------------------------------------------------
    /// @brief The advection portion of the semi-lagrangian algorithm
    //----------------------------------------------------------------------------------------------------------------------
    void advectVelocityField();
    //----------------------------------------------------------------------------------------------------------------------
    /// @brief Updates based on the body forces, such as gravity
    //----------------------------------------------------------------------------------------------------------------------
    void addBodyForce();
    //----------------------------------------------------------------------------------------------------------------------
    /// @brief The projection step, handles the pressure and incrompressibility portion of the fluid algoritm
    //----------------------------------------------------------------------------------------------------------------------
    void project();
    //----------------------------------------------------------------------------------------------------------------------
    /// @brief Calculates the time step of the fluid equation (how many steps per frame)
    //----------------------------------------------------------------------------------------------------------------------
    real cfl();


    //----------------------------------------------------------------------------------------------------------------------
    /// @brief The grid that we store the particles in, and calculate based on
    //----------------------------------------------------------------------------------------------------------------------
    MACGrid m_MACGrid;

    //----------------------------------------------------------------------------------------------------------------------
    /// @brief The dimensions of the grid, cells in the x,y,z directions
    //----------------------------------------------------------------------------------------------------------------------
    uint m_iSize, m_jSize, m_kSize;

    //----------------------------------------------------------------------------------------------------------------------
    /// @brief The user defined scalar for the cfl function
    //----------------------------------------------------------------------------------------------------------------------
    real m_k_cfl = 1.0;

};

#endif
